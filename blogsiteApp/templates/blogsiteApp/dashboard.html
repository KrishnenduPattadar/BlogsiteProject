{% extends 'blogsiteApp/base.html' %}

{% block content %}
<div class="container mt-5 text-white bg-dark min-vh-100">
    <h2 class="mb-4 text-center text-info">All Blog Posts</h2>

    {% for blog in blogs %}
    <div class="card mb-4 bg-secondary bg-opacity-25 border-light shadow">
        <div class="card-body">
            <div class="d-flex align-items-center mb-2">
                <strong class="me-2 text-info">{{ blog.user.username }}</strong>
            </div>

            {% if blog.image %}
            <img src="{{ blog.image.url }}" class="img-fluid mb-3 rounded shadow" style="max-height: 300px; object-fit: cover;">
            {% endif %}

            <p class="text-light">{{ blog.description }}</p>

            {% if blog.user == user %}
            <div class="mb-2">
                <a href="{% url 'edit_post' blog.id %}" class="btn btn-sm btn-outline-info">Edit</a>
                <a href="{% url 'delete_post' blog.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
            </div>
            {% endif %}

            <!-- Comments Section -->
            <div class="mt-4">
                <font size="5">
                <h6 class="text-light mb-2">ðŸ’¬ Total Comments </font><span class="text-info">({{ blog.comments.count }})</span></h6>

                {% for comment in blog.comments.all %}
                <div class="border rounded p-2 mb-2 bg-dark text-white border-secondary">
                    <strong class="text-info">{{ comment.user.username }}:</strong>

                    {% if request.GET.edit_comment_id == comment.id|stringformat:"s" %}
                    <form method="POST" action="{% url 'comment_edit' comment.id %}">
                        {% csrf_token %}
                        <textarea name="new_content" rows="2" class="form-control bg-dark text-white border-info mt-2" required>{{ comment.content }}</textarea>
                        <div class="mt-2">
                            <button type="submit" class="btn btn-sm btn-success">Update</button>
                            <a href="{% url 'dashboard' %}" class="btn btn-sm btn-secondary">Cancel</a>
                        </div>
                    </form>
                    {% else %}
                    <p class="text-light mt-1">{{ comment.content }}</p>

                    {% if comment.user == request.user %}
                    <div class="mt-2">
                        <a href="?edit_comment_id={{ comment.id }}" class="btn btn-sm btn-outline-info">Edit</a>
                        <form method="POST" action="{% url 'comment_delete' comment.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this comment?');">Delete</button>
                        </form>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No comments yet.</p>
                {% endfor %}

                <!-- Comment Form -->
                <form method="POST" action="{% url 'comment_on_post' blog.id %}" class="mt-3">
                    {% csrf_token %}
                    <div class="form-group">
                        <textarea name="content" class="form-control bg-dark text-white border-info" rows="2" placeholder="Write a comment..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm btn-info mt-2">Add Comment</button>
                </form>
            </div>
        </div>
    </div>
    {% empty %}
    <p class="text-muted text-center">No posts available.</p>
    {% endfor %}
</div>
{% endblock %}
